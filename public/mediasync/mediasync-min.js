var mediascape=function(e){var t;var a=function(e,t,n){var r=n.query();if(0===r.vel){var o=function(){a(e,t,n)};return n.on("change",function(){0!==this.query().vel&&(n.off("change",o),o())}),this}var i=(t-r.pos)/r.vel;return i>.001?(setTimeout(function(){a(e,t,n)},i/2/r.vel*1e3),this):(e.call(),{cancel:function(){}})};return e.mediaSync=function(e,t,n){var r;(n=n||{}).skew=n.skew||0,n.target=n.target||.025,n.original_target=n.target,n.loop=n.loop||!1,n.target=2*n.target,n.mode||(-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")?n.mode="skip":n.mode="auto"),void 0===n.remember&&(n.remember=!1),(n.debug||!1===n.remember)&&(localStorage.removeItem("mediasync_vpbr"),n.remember=!1),void 0===n.automute&&(n.automute=!1);var o=!1,i=function(){try{var t=e.play();t&&t.catch(function(e){U("error",{event:"error",op:"play",msg:e})})}catch(e){U("error",{event:"error",op:"play"})}},s=function(e){w=0,M=[],y=null,t.pos<-n.skew&&t.vel>0?setTimeout(function(){a(s,-n.skew,t)},100):void 0!==f?f(e):console.log("WARNING: onchange but no update func yet")},c=function(e){w=0,u&&u.off("change",s),(u=e).version>=3&&(u.__defineGetter__("pos",function(){return u.query().position}),u.__defineGetter__("vel",function(){return u.query().velocity}),u.__defineGetter__("acc",function(){return u.query().acceleration})),u.on("change",s)};t||console.log("WARNING: No motion has been set");var u,p=!1,l=!1;function v(){1==u.vel&&i()}function d(){0===u.vel&&e.pause()}function m(){console.log(err),k()}var f,g,y,b,k=function(){p=!0,e.removeEventListener("paused",v),e.removeEventListener("playing",d),e.removeEventListener("error",m)},w=0,_=0,M=[],E=0,R=5,S=!1,O=0,T=function(t){if(0!==e.readyState){if(1!=u.vel)return e.currentTime=t,y=void 0,void U("skip",{event:"skip",pos:t,target:u.pos,adjust:0});var a=0,r=performance.now();if(y){r-y.ts<1500?(O+=1)>3&&(K("Lost all confidence (thrashing)"),n.target=Math.min(1,2*n.target),U("target_change",{event:"target_change",target:n.target,reason:"thrashing"}),O=0):O=0;var o=(r-y.ts)/1e3,i=e.currentTime,s=L(y.pos+o)-i;a=y.adjust+s,Math.abs(a)>5&&(a=0)}e.playbackRate=1,K({type:"skip",pos:t+a,target:L(u.pos),adjust:a}),R=Math.min(5,R+5),1!=u.vel?e.currentTime=t:(e.currentTime=t+a,y={ts:r,pos:t,adjust:a}),S&&(S=!1,U("sync",{event:"sync",sync:!1})),U("skip",{event:"skip",pos:t+a,target:u.pos,adjust:a})}};function L(t){return n.loop?n.duration?t%n.duration:t%e.duration:t}var N,P,V,x=function(t){if(!p&&!l){var a=A();L(a.pos),L(a.pos);var r=L(a.pos+n.skew),s=e.duration;if(s&&(r<0||r>s))e.paused||e.pause();else{0!==a.vel?e.paused&&i():e.paused||e.pause();try{if(!g&&w>40)throw o&&(e.muted=!1,o=!1),U("muted",{event:"muted",muted:!1}),new Error("Variable playback rate seems broken - "+w+" bad");var c=performance.now(),v=r-e.currentTime;if(v<-1||0===a.vel||Math.abs(v)>1){K({type:"jump",diff:v});var d=L(a.pos+n.skew);return void(performance.now()-E>150&&(E=performance.now(),T(d)))}b&&Math.abs(v-b)>.5&&(w+=10),M.push({diff:v,ts:c,pos:r});M[M.length-1].pos,M[0].pos,M[M.length-1].ts,M[0].ts;if(!(M.length>=3))return;for(var m=0,f=0;f<M.length;f++)m+=M[f].diff;v=m/M.length,M.length>3&&(M=M.splice(0,1));K({type:"dbg",diff:v,bad:w,vpbr:g});var h=function(e,t){return Math.min(u.vel+e,Math.max(u.vel-e,u.vel+t))};Math.abs(v)>1?(M=[],e.playbackRate=h(1,1.3*v),b=v,K({type:"vpbr",level:"coarse",rate:e.playbackRate}),w+=4):Math.abs(v)>.5?(M=[],e.playbackRate=h(.5,.75*v),b=v,K({type:"vpbr",level:"mid",rate:e.playbackRate}),w+=2):Math.abs(v)>.1?(M=[],e.playbackRate=h(.4,.75*v),b=v,K({type:"vpbr",level:"midfine",rate:e.playbackRate}),w+=1):Math.abs(v)>.025?(M=[],e.playbackRate,e.playbackRate=h(.3,.6*v),b=v,K({type:"vpbr",level:"fine",rate:e.playbackRate})):(g||(w=Math.max(0,w-20),++_>5&&(g=!0,localStorage&&n.remember&&(K("Variable Playback Rate capability stored"),localStorage.mediasync_vpbr=JSON.stringify({appVersion:navigator.appVersion,vpbr:!0})))),S||(S=!0,U("sync",{event:"sync",sync:!0})),e.playbackRate=h(.02,.07*v),b=v),n.automute&&(!e.muted&&(e.playbackRate>1.05||e.playbackRate<.95)?(o=!0,e.muted=!0,U("muted",{event:"muted",muted:!0}),K({type:"mute",muted:!0})):e.muted&&o&&(o=!1,e.muted=!1,K({type:"mute",muted:!1}),U("muted",{event:"muted",muted:!1})))}catch(t){n.automute&&(e.muted=!1),y=null,localStorage&&n.remember&&(K("Variable Playback Rate NOT SUPPORTED, remembering this  "),console.log("Variable playback speed not supported (remembered)"),localStorage.mediasync_vpbr=JSON.stringify({appVersion:navigator.appVersion,vpbr:!1})),console.log("Error setting variable playback speed - seems broken",t),J(I)}}}},I=function(t){if(!p&&!l){var a,r=A(),o=e.duration;if(o&&(r.pos<0||r.pos>o))e.paused||(e.currentTime=o-.03,e.pause());else{if(r.vel>0?e.paused&&i():e.paused||e.pause(),1!=r.vel){if(L(r.pos)==N)return;return N=r.pos,K("Jump, playback speed is not :",r.vel),a=L(r.pos+n.skew),void(e.currentTime!=a&&T(a))}var s=r.pos+n.skew,c=s-e.currentTime,v=performance.now();if(void 0!==t&&void 0!==t.pos)return K("MOTION JUMP"),a=r.pos+n.skew,void T(a);if(M.push({diff:c,ts:v,pos:s}),M.length>=3){for(var d=0,m=0;m<M.length;m++)d+=M[m].diff;if(c=d/M.length,M.splice(0,1),Math.abs(c)<.001&&(R=Math.max(5,R)),R<=-2?(K("Lost all confidence"),n.target=Math.min(1,1.4*n.target),R=0,U("target_change",{event:"target_change",target:n.target,reason:"unknown"})):R>15&&(K("Feels better"),n.target==n.original_target&&(S||(S=!0,U("sync",{event:"sync",sync:!0}))),n.target=Math.max(.7*Math.abs(c),n.original_target),R-=8,U("target_change",{event:"target_change",target:n.target,reason:"improving"})),K({type:"dbg",diff:c,target:n.target,perfect:R}),Math.abs(c)>n.target){if((R-=1)>0)return;a=u.pos+n.skew,R+=8,T(a)}else Math.abs(c-P)<n.target/2&&R++,P=c}}}},q=!1,j=function(){if(!q){if(q=!0,void 0===u&&c(t),localStorage&&n.remember&&localStorage.mediasync_vpbr){var a=JSON.parse(localStorage.mediasync_vpbr);a.appVersion===navigator.appVersion&&(g=a.vpbr)}"vpbr"===n.mode&&(g=!0),"skip"===n.mode||!1===g?(e.playbackRate=1,f=I):(n.automute&&(e.muted=!0,o=!0,U("muted",{event:"muted",muted:!0})),f=x),e.removeEventListener("canplay",j),e.removeEventListener("playing",j),J(f)}};e.addEventListener("canplay",j),e.addEventListener("playing",j);var J=function(t){V&&(clearInterval(void 0),e.removeEventListener("timeupdate",V),e.removeEventListener("pause",V),e.removeEventListener("ended",V)),V=t,e.playbackRate=1,e.addEventListener("timeupdate",t),e.addEventListener("pause",t),e.addEventListener("ended",t),U("mode_change",t===x?{event:"mode_change",mode:"vpbr"}:{event:"mode_change",mode:"skip"})},A=function(){if(u.version>=3){var e=u.query();return{pos:e.position,vel:e.velocity,acc:e.acceleration}}return u.query()},C=setInterval(function(){if(e.readyState>=2){clearInterval(C);try{var t=new Event("canplay");e.dispatchEvent(t)}catch(t){var a=document.createEvent("Event");a.initEvent("canplay",!0,!1),e.dispatchEvent(a)}}},100),G={skip:[],mode_change:[],target_change:[],muted:[],sync:[],error:[]},U=function(e,t){if(!G.hasOwnProperty(e))throw"Unsupported event: "+e;for(var a=0;a<G[e].length;a++){h=G[e][a];try{h.call(r,t)}catch(t){console.log("Error in "+e+": "+h+": "+t)}}};function K(){if(n.debug)if("function"==typeof n.debug){var e=arguments;setTimeout(function(){n.debug.apply(window,e)},0)}else{var t=[];for(var a in arguments)t.push(arguments[a]);console.log(JSON.stringify(t))}}return r={setSkew:function(e){n.skew=e},getSkew:function(){return n.skew},setOption:function(e,t){n[e]=t,"target"===e&&(n.original_target=t)},getMethod:function(){return f===x?"playbackRate":"skip"},setMotion:c,stop:k,pause:function(e){void 0===e&&(e=!0),(l=e)||s()},on:function(e,t,a){if(!G.hasOwnProperty(e))throw new Error("Unsupported event: "+e);if(!t||"function"!=typeof t)throw"Illegal handler";if(-1!=G[e].indexOf(t))throw new Error("Already registered");return G[e].push(t),setTimeout(function(){"sync"===e&&U(e,{event:e,sync:S},t),"muted"===e&&U(e,{event:e,muted:o},t)},0),r},off:function(e,t){if(!G.hasOwnProperty(e))throw"Unknown parameter "+e;var a=G[e].indexOf(t);return a>-1&&G[e].splice(a,1),r},init:j}},e.mediaNeedKick=function(e,a){if(!1===t)return!1;if(e.canplay)return t=!1,!1;var n,r=e.volume;e.volume=.01;try{n=e.play()}catch(e){a(e)}return void 0!==n&&n.then?n.then(function(){setTimeout(function(){e.pause(),e.volume=r},0)}).catch(function(e){a?a(e):console.log("Play failed, pass an error function to the needKick function to handle it (likely get the user to click a play button)")}):(t=!0===e.paused,e.pause(),e.volume=r),t&&a&&a("Play failed"),t},e}(mediascape||{});window.hasOwnProperty("MCorp")||(MCorp={}),MCorp.mediaSync=mediascape.mediaSync,MCorp.mediaNeedKick=mediascape.mediaNeedKick;